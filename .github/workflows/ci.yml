# This is the name of the workflow that will be displayed on GitHub
name: Rust CI

# This section defines when the workflow will run.
# It will trigger on any `push` to any branch, and on any `pull_request`.
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

# This defines the environment for the workflow. We set Cargo to use color output.
env:
  CARGO_TERM_COLOR: always

# This section defines the jobs to be run. We have one job called "build".
jobs:
  build:
    # The name that will be displayed for this job on GitHub
    name: Test on ${{ matrix.os }}

    # This job will run on multiple operating systems to ensure cross-platform compatibility
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    # These are the individual steps the job will execute in order
    steps:
    # 1. Check out the repository code so the workflow can access it
    - uses: actions/checkout@v4

    - name: Install FFmpeg deps (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          ffmpeg \
          pkg-config \
          libglib2.0-dev \
          libgtk-3-dev \
          libxdo-dev \
          libavcodec-dev \
          libavformat-dev \
          libavutil-dev \
          libswresample-dev \
          libswscale-dev \
          libasound2-dev

        echo "PKG_CONFIG_PATH=/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/share/pkgconfig" >> $GITHUB_ENV
        pkg-config --modversion glib-2.0

    - name: Install FFmpeg deps (macOS)
      if: runner.os == 'macOS'
      run: |
        brew update
        brew install ffmpeg pkg-config
        FFMPEG_PREFIX="$(brew --prefix ffmpeg)"
        echo "FFMPEG_INCLUDE_DIR=$FFMPEG_PREFIX/include" >> $GITHUB_ENV
        echo "FFMPEG_LIB_DIR=$FFMPEG_PREFIX/lib" >> $GITHUB_ENV
        echo "FFMPEG_INCLUDE_DIR_AARCH64_APPLE_DARWIN=$FFMPEG_PREFIX/include" >> $GITHUB_ENV
        echo "FFMPEG_LIB_DIR_AARCH64_APPLE_DARWIN=$FFMPEG_PREFIX/lib" >> $GITHUB_ENV
        echo "FFMPEG_INCLUDE_DIR_X86_64_APPLE_DARWIN=$FFMPEG_PREFIX/include" >> $GITHUB_ENV
        echo "FFMPEG_LIB_DIR_X86_64_APPLE_DARWIN=$FFMPEG_PREFIX/lib" >> $GITHUB_ENV
        echo "PKG_CONFIG_PATH=$FFMPEG_PREFIX/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV
        pkg-config --modversion libavcodec

    - name: Prepare FFmpeg DLLs (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $ErrorActionPreference = "Stop"

        $ffmpegUrl = "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-full-shared.7z"
        $archive = "$env:RUNNER_TEMP\ffmpeg-shared.7z"
        $extractRoot = "$env:RUNNER_TEMP\ffmpeg"

        Invoke-WebRequest -Uri $ffmpegUrl -OutFile $archive
        7z x $archive "-o$extractRoot" -y | Out-Null

        $ffmpegBin = Get-ChildItem $extractRoot -Recurse -Directory |
          Where-Object { $_.Name -eq "bin" } |
          Select-Object -First 1 -ExpandProperty FullName
        $ffmpegInclude = Get-ChildItem $extractRoot -Recurse -Directory |
          Where-Object { $_.Name -eq "include" } |
          Select-Object -First 1 -ExpandProperty FullName
        $ffmpegLib = Get-ChildItem $extractRoot -Recurse -File -Filter "avcodec.lib" |
          Select-Object -First 1 -ExpandProperty DirectoryName

        if (-not $ffmpegBin) {
          throw "Could not find extracted FFmpeg bin directory."
        }
        if (-not $ffmpegInclude) {
          throw "Could not find extracted FFmpeg include directory."
        }
        if (-not $ffmpegLib) {
          throw "Could not find extracted FFmpeg lib directory (avcodec.lib)."
        }

        New-Item -ItemType Directory -Force -Path "third_party/ffmpeg/bin" | Out-Null

        $required = @(
          "avcodec-*.dll",
          "avformat-*.dll",
          "avutil-*.dll",
          "swresample-*.dll",
          "swscale-*.dll"
        )

        foreach ($pattern in $required) {
          $matches = Get-ChildItem -Path $ffmpegBin -Filter $pattern
          if (-not $matches) {
            throw "Missing required FFmpeg DLL pattern: $pattern"
          }
          Copy-Item -Path $matches.FullName -Destination "third_party/ffmpeg/bin" -Force
        }

        "FFMPEG_INCLUDE_DIR=$ffmpegInclude" >> $env:GITHUB_ENV
        "FFMPEG_INCLUDE_DIR_X86_64_PC_WINDOWS_MSVC=$ffmpegInclude" >> $env:GITHUB_ENV
        "FFMPEG_LIB_DIR=$ffmpegLib" >> $env:GITHUB_ENV
        "FFMPEG_LIB_DIR_X86_64_PC_WINDOWS_MSVC=$ffmpegLib" >> $env:GITHUB_ENV

    # 2. Cache the cargo directories to speed up future builds
    - name: Cache cargo dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    # 3. Check that the code is formatted correctly
    # - name: Check formatting
    #  run: cargo fmt -- --check

    # 4. Run Clippy to check for common mistakes and enforce idiomatic Rust
    #    The `-D warnings` flag treats all warnings as errors, failing the build.
    - name: Run Clippy
      run: cargo clippy

    # 5. Run the tests (if any are defined)
    - name: Run tests
      run: cargo test --verbose

    # 6. Build the project in release mode to ensure it compiles
    - name: Build
      run: cargo build --release --verbose
